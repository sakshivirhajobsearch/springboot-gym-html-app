name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ca-certificates \
          curl \
          gnupg \
          lsb-release

        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
          $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

        sudo apt-get update
        sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    - name: Verify Docker installation
      run: docker --version

    - name: Build with Maven
      run: mvn clean install

    - name: Test with Maven
      run: mvn test

    - name: Package with Maven
      run: mvn package

    - name: Build Docker Image
      run: docker build -t sakshivirhajobsearch/gym-html-app .

    - name: Login to DockerHub
      env:
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: echo "Job123Job#" | docker login -u "sakshivirhajobsearch" --password-stdin

    - name: Push Docker Image
      run: docker push sakshivirhajobsearch/gym-html-app

    - name: Run Docker container (optional for testing)
      run: docker run -d -p 8080:8080 sakshivirhajobsearch/gym-html-app
